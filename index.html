<!doctype html>
<html>

<head>
<title>JavaScript Minesweeper</title>
<meta charset="utf-8" />
</head>

<body style="background-color:black;">

<!-- height is 256 for the game board and 33 for the counters -->
<div style="width:480px;height:289px;margin-left:auto;margin-right:auto;">
<canvas id="canvas" style="border:1px solid black;" width="480" height="289">It appears that your browser doesn't support the canvas element.</canvas>
</div>

<br />
<br />

<div style="width:144px;margin-left:auto;margin-right:auto;">
<input style="width:144px;" type="button" onclick="Javascript:newGame()" value="New Game" />
</div>

<br />

<div id=output style="width:144px;height:144px;margin-left:auto;margin-right:auto;">
&nbsp;
</div>

<script>

"use strict";

var x, y;

// Beginner: 8 × 8 or 9 × 9 field with 10 mines
// Intermediate: 16 × 16 field with 40 mines
// Expert: 30 × 16 field with 99 mines

// 144 x 144
// 256 x 256
// 480 x 256

var FIELDWIDTH = 30;
var FIELDHEIGHT = 16;
var NUMBEROFBOMBS = 99;
var CANVASWIDTH = 480;
var CANVASHEIGHT = 256;

var HIDDEN = 0;
var EMPTY = 1;
var BOMB = 2;
var EXPLODED = 3;
var FLAG = 4;
var ONE = 5;
var TWO = 6;
var THREE = 7;
var FOUR = 8;
var FIVE = 9;
var SIX = 10;
var squares = new Array(FIELDWIDTH);
for (x = 0; x < FIELDWIDTH; x += 1) {
    squares[x] = new Array(FIELDHEIGHT);
}

var NOTGUESSED = 0;
var GUESSED = 1;
var FLAGGED = 2;
var MOUSEDOWN = 3;
var guesses;

function resetGuesses() {
	guesses = new Array(FIELDWIDTH);
	for (x = 0; x < FIELDWIDTH; x += 1) {
		guesses[x] = new Array(FIELDHEIGHT);
		for (y = 0; y < FIELDHEIGHT; y += 1) {
			guesses[x][y] = NOTGUESSED;
		}
	}
}

var bombsIdentified = 0;
var gamestart = 0;
var gameover = 0;
var seconds = 0;
var tmr = 0;

var i, j;
function isBomb(i, j) {
	var retVal = 0;
    // We don't want to check off the side of the grid
    if (i > -1 && i < FIELDWIDTH && j > -1 && j < FIELDHEIGHT) {
        if (squares[i][j] === BOMB) {
            retVal = 1;
        }
    }
    return retVal;
}

var canvas;
var context;
var sprite;
function drawField() {
	document.getElementById('output').style.color = 'white';
	var status = '';

	// Draw background for counters
    context.drawImage(sprite, 5, 5, 6, 6, 0, 0, 480, 33);

	// Draw housings for counters
	context.drawImage(sprite, 0, 39, 41, 25,   5, 4, 41, 25);
	context.drawImage(sprite, 0, 39, 41, 25, 434, 4, 41, 25);

	if (gameover) {
		context.drawImage(sprite, 68, 39, 27, 27, 227, 2, 27, 27);
	} else {
		context.drawImage(sprite, 41, 39, 27, 27, 227, 2, 27, 27);
	}

    for (x = 0; x < FIELDWIDTH; x += 1) {
        for (y = 0; y < FIELDHEIGHT; y += 1) {
        	// Adding 33 to give space for the bombs and time counters
            if (guesses[x][y] === MOUSEDOWN) {
                context.drawImage(sprite, 1 * 16, 0, 16, 16, x * 16, (y * 16) + 33, 16, 16);
            } else if (guesses[x][y] === FLAGGED) {
                context.drawImage(sprite, 4 * 16, 0, 16, 16, x * 16, (y * 16) + 33, 16, 16);
            } else if (guesses[x][y] === GUESSED) {
                context.drawImage(sprite, squares[x][y] * 16, 0, 16, 16, x * 16, (y * 16) + 33, 16, 16);
            } else {
                context.drawImage(sprite, 0 * 16, 0, 16, 16, x * 16, (y * 16) + 33, 16, 16);
            }
        }
    }

    var strBombsIdentified = String(bombsIdentified);
    var strlen = strBombsIdentified.length;
	if (strlen === 3) {
		context.drawImage(sprite, (parseInt(strBombsIdentified[0]))*13, 16, 13, 23,  6, 5, 13, 23);
    	context.drawImage(sprite, (parseInt(strBombsIdentified[1]))*13, 16, 13, 23, 19, 5, 13, 23);
	    context.drawImage(sprite, (parseInt(strBombsIdentified[2]))*13, 16, 13, 23, 32, 5, 13, 23);
	} else if (strlen === 2) {
		context.drawImage(sprite, 0*13, 16, 13, 23,  6, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strBombsIdentified[0]))*13, 16, 13, 23, 19, 5, 13, 23);
    	context.drawImage(sprite, (parseInt(strBombsIdentified[1]))*13, 16, 13, 23, 32, 5, 13, 23);
	} else if (strlen === 1) {
		context.drawImage(sprite, 0*13, 16, 13, 23,  6, 5, 13, 23);
		context.drawImage(sprite, 0*13, 16, 13, 23, 19, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strBombsIdentified[0]))*13, 16, 13, 23, 32, 5, 13, 23);
	}

    var strSeconds = String(seconds);
    strlen = strSeconds.length;
	if (strlen === 3) {
		context.drawImage(sprite, (parseInt(strSeconds[0]))*13, 16, 13, 23, 435, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strSeconds[1]))*13, 16, 13, 23, 448, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strSeconds[2]))*13, 16, 13, 23, 461, 5, 13, 23);
	} else if (strlen === 2) {
		context.drawImage(sprite, 0*13, 16, 13, 23, 435, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strSeconds[0]))*13, 16, 13, 23, 448, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strSeconds[1]))*13, 16, 13, 23, 461, 5, 13, 23);
	} else if (strlen === 1) {
		context.drawImage(sprite, 0*13, 16, 13, 23, 435, 5, 13, 23);
		context.drawImage(sprite, 0*13, 16, 13, 23, 448, 5, 13, 23);
		context.drawImage(sprite, (parseInt(strSeconds[0]))*13, 16, 13, 23, 461, 5, 13, 23);
	}

	if(bombsIdentified === NUMBEROFBOMBS) {
		context.drawImage(sprite, 95, 39, 27, 27, 227, 2, 27, 27);
		alert('Yay!. You won in ' + seconds + ' seconds!');
		clearInterval(tmr);
	}
}

function userMousedDown(evt) {
    var clickX, clickY;
	evt.preventDefault();
	if (!gameover) {
		clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
		clickY = Math.floor(((evt.pageY - canvas.offsetTop) - 33) / 16); // subtracting 33 for the counters
		if (guesses[clickX][clickY] === NOTGUESSED) {
			guesses[clickX][clickY] = MOUSEDOWN;
		}
	}
    drawField();
}

function checkForAdjacentBlanks(andy, bob) {
//	alert(andy + ', ' + bob);
	var retVal = 0;
	var r, s;
	r = andy;
	s = bob;
	if(s > 0) {
		if (r > 0) {
			if(squares[r - 1][s - 1] === EMPTY || squares[r - 1][s - 1] > 4) {
				guesses[r - 1][s - 1] = GUESSED;
		//		checkForAdjacentBlanks(r - 1, s - 1);
			}
		}
		if(squares[r][s - 1] === EMPTY || squares[r][s - 1] > 4) {
			guesses[r][s - 1] = GUESSED;
		//	checkForAdjacentBlanks(r, s - 1);
		}
		if (r < FIELDWIDTH-1) {
			if(squares[r + 1][s - 1] === EMPTY || squares[r + 1][s - 1] > 4) {
				guesses[r + 1][s - 1] = GUESSED;
		//		checkForAdjacentBlanks(r + 1, s - 1);
			}
		}
	}
	if (r > 0) {
		if(squares[r - 1][s] === EMPTY || squares[r - 1][s] > 4) {
			guesses[r - 1][s] = GUESSED;
		//	checkForAdjacentBlanks(r - 1, s);
		}
	}
	if(squares[r][s] === EMPTY || squares[r][s] > 4) {
		guesses[r][s] = GUESSED;
//		checkForAdjacentBlanks(r, s);
	}
	if (r < FIELDWIDTH-1) {
		if(squares[r + 1][s] === EMPTY || squares[r + 1][s] > 4) {
			guesses[r + 1][s] = GUESSED;
		//	checkForAdjacentBlanks(r + 1, s);
		}
	}
	if(s < FIELDHEIGHT-1) {
		if (r > 0) {
			if(squares[r - 1][s + 1] === EMPTY || squares[r - 1][s + 1] > 4) {
				guesses[r - 1][s + 1] = GUESSED;
		//		checkForAdjacentBlanks(r - 1, s + 1);
			}
		}
		if(squares[r][s + 1] === EMPTY || squares[r][s + 1] > 4) {
			guesses[r][s + 1] = GUESSED;
		//	checkForAdjacentBlanks(r, s + 1);
		}
		if (r < FIELDWIDTH-1) {
			if(squares[r + 1][s + 1] === EMPTY || squares[r + 1][s + 1] > 4) {
				guesses[r + 1][s + 1] = GUESSED;
		//		checkForAdjacentBlanks(r + 1, s + 1);
			}
		}
	}
}

function clock() {
	seconds += 1;
    drawField();
}

function userMousedUp(evt) {
	evt.preventDefault();
    var clickX, clickY;
    clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
    clickY = Math.floor(((evt.pageY - canvas.offsetTop) - 33) / 16); // subtracting 33 for the counters

	if (gamestart === 0) {
		gamestart = 1;
		tmr = setInterval(function(){clock()},1000);
	}

    // If right-click
	if (evt.button === 2) {
		// Don't let the player make changes when the game is over
		if (!gameover) {
			if (guesses[clickX][clickY] == FLAGGED) {
				guesses[clickX][clickY] = NOTGUESSED;
				bombsIdentified -= 1;
			} else if (guesses[clickX][clickY] === GUESSED) {
				// Do nothing to square that have already been cleared
			} else {
				guesses[clickX][clickY] = FLAGGED;
				bombsIdentified += 1;
			}
		}
	// If left-click
	} else {
		if ((evt.pageX - canvas.offsetLeft) > 228 && (evt.pageX - canvas.offsetLeft) < 254 && (evt.pageY - canvas.offsetTop) > 3 && (evt.pageY - canvas.offsetTop) < 29 ) {
			newGame();
		} else if (squares[clickX][clickY] === BOMB) {
			for (x = 0; x < FIELDWIDTH; x += 1) {
				for (y = 0; y < FIELDHEIGHT; y += 1) {
					guesses[x][y] = GUESSED;
				}
			}
			squares[clickX][clickY] === EXPLODED;
			gameover = 1;
			clearInterval(tmr);
		} else {
			// if game isn't over and
			// square is currently hidden
			if (!gameover && guesses[clickX][clickY] !== GUESSED) {
				guesses[clickX][clickY] = GUESSED;
				// TODO Check for adjacent blanks
				checkForAdjacentBlanks(clickX, clickY);
			}
		}
	}
    drawField();
}

function userRightClicked(evt) {
	evt.preventDefault();
}

function userKeyUp(evt) {
	if (evt.keyCode == 78 ) {
		newGame();
	}
}

function newGame() {
	gameover = 0;
	bombsIdentified = 0;
	seconds = 0;
	if(tmr)
		clearInterval(tmr);
	gamestart = 0;

	resetGuesses();

    canvas = document.getElementById('canvas');
    context = canvas.getContext('2d');

    canvas.addEventListener("contextmenu", userRightClicked, false);
    canvas.addEventListener("longpress", userRightClicked, false);
    canvas.addEventListener("mousedown", userMousedDown, false);
    canvas.addEventListener("mouseup", userMousedUp, false);
    window.addEventListener("keyup", userKeyUp, false);

    sprite = new Image();
    sprite.src = 'mines.png';

    for (x = 0; x < FIELDWIDTH; x += 1) {
        for (y = 0; y < FIELDHEIGHT; y += 1) {
            squares[x][y] = EMPTY;
        }
    }

    // Generate bomb locations
    x = 0;
    while (x < NUMBEROFBOMBS) {
        var randomX = Math.floor(Math.random() * FIELDWIDTH), randomY = Math.floor(Math.random() * FIELDHEIGHT);
        if (squares[randomX][randomY] !== BOMB) {
            squares[randomX][randomY] = BOMB;
            x += 1;
        }
    }

    // Generate neighbour counts
    for (x = 0; x < FIELDWIDTH; x += 1) {
        for (y = 0; y < FIELDHEIGHT; y += 1) {
            if (squares[x][y] !== BOMB) {
                var count = 0;
                count = count + isBomb(x - 1, y - 1);
                count = count + isBomb(x, y - 1);
                count = count + isBomb(x + 1, y - 1);

                count = count + isBomb(x - 1, y);
                count = count + isBomb(x + 1, y);

                count = count + isBomb(x - 1, y + 1);
                count = count + isBomb(x, y + 1);
                count = count + isBomb(x + 1, y + 1);
                if (count > 0) squares[x][y] = 4 + count;
            }
        }
    }

    // Draw minefield
    sprite.onload = function() {
        drawField();
    }

}

newGame();

</script>

</body>

</html>