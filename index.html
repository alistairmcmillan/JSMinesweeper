<!doctype html>
<html>

<head>
<title>JavaScript Minesweeper</title>
<meta charset="utf-8" />
</head>

<body style="background-color:black;">

<div id='scoreboard' style="width:144px;margin-left:auto;margin-right:auto;color:black;font-size:25px;text-align:center;">
0
</div>

<div style="width:144px;height:144px;margin-left:auto;margin-right:auto;">
<canvas id="canvas" style="border:1px solid black;background-color:white;" width="144" height="144">It appears that your browser doesn't support the canvas element.</canvas>
</div>

<script>

"use strict";

var HIDDEN = 0;
var EMPTY = 1;
var BOMB = 2;
var EXPLODED = 3;
var FLAG = 4;
var ONE = 5;
var TWO = 6;
var THREE = 7;
var FOUR = 8;
var FIVE = 9;
var SIX = 10;

var score = 0;
var gameover = 0;

var x, y;
var squares = new Array(9);
for (x = 0; x < 9; x += 1) {
    squares[x] = new Array(9);
}
var guesses = new Array(9);
for (x = 0; x < 9; x += 1) {
    guesses[x] = new Array(9);
}

var i, j;
function isBomb(i, j) {
    // We don't want to check off the side of the grid
    if (i > -1 && i < 9 && j > -1 && j < 9) {
        if (squares[i][j] === BOMB) {
            return 1;
        } else {
            return 0;
        }
    } else {
        return 0;
    }
}

var canvas;
var context;
var sprite;
function drawField() {
    for (x = 0; x < 9; x += 1) {
        for (y = 0; y < 9; y += 1) {
			// 0 means not guessed
			// 1 means has clicked
			// 2 means flagged
			// 3 means mousedown
            if (guesses[x][y] === 3) {
                context.drawImage(sprite, 1 * 16, 0, 16, 16, x * 16, y * 16, 16, 16);
            } else if (guesses[x][y] === 2) {
                context.drawImage(sprite, 4 * 16, 0, 16, 16, x * 16, y * 16, 16, 16);
            } else if (guesses[x][y] === 1) {
                context.drawImage(sprite, squares[x][y] * 16, 0, 16, 16, x * 16, y * 16, 16, 16);
            } else {
                context.drawImage(sprite, 0 * 16, 0, 16, 16, x * 16, y * 16, 16, 16);
            }
        }
    }
}

function userMousedDown(evt) {
    var clickX, clickY;

	evt.preventDefault();
	if (!gameover) {
		clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
		clickY = Math.floor((evt.pageY - canvas.offsetTop) / 16);
	//	if (guesses[clickX][clickY] == 0) {
			guesses[clickX][clickY] = 3;
	//	}
	}
    drawField();
}

function userMousedUp(evt) {
	evt.preventDefault();
    var clickX, clickY;
    clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
    clickY = Math.floor((evt.pageY - canvas.offsetTop) / 16);
	if (evt.button === 2) {
		// Don't let the player make changes when the game is over
		if (!gameover) {
			clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
			clickY = Math.floor((evt.pageY - canvas.offsetTop) / 16);
			if (guesses[clickX][clickY] === 2) {
				guesses[clickX][clickY] = 0;
			} else if (guesses[clickX][clickY] === 1) {
				// Do nothing to square that have already been cleared
			} else {
				guesses[clickX][clickY] = 2;
			}
		}
	} else {
		if (squares[clickX][clickY] === BOMB) {
			for (x = 0; x < 9; x += 1) {
				for (y = 0; y < 9; y += 1) {
					guesses[x][y] = 1;
				}
			}
			squares[clickX][clickY] === EXPLODED;
			gameover = 1;
		} else {
			if (!gameover && guesses[clickX][clickY] != 1) {
				guesses[clickX][clickY] = 1;
				score += 1;
				document.getElementById('scoreboard').style.color = 'white';
				document.getElementById('scoreboard').textContent = score;
			}
		}
	}
    drawField();
}

function userRightClicked(evt) {
	evt.preventDefault();
}

/*
function userRightClicked(evt) {
    var clickX, clickY;
	evt.preventDefault();

	// Don't let the player make changes when the game is over
	if (!gameover) {
		clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
		clickY = Math.floor((evt.pageY - canvas.offsetTop) / 16);
		if (guesses[clickX][clickY] === 2) {
			guesses[clickX][clickY] = 0;
		} else if (guesses[clickX][clickY] === 1) {
			// Do nothing to square that have already been cleared
		} else {
			guesses[clickX][clickY] = 2;
		}
		drawField();
	}
}

function userLeftClicked(evt) {
	evt.preventDefault();
    var clickX, clickY;
    clickX = Math.floor((evt.pageX - canvas.offsetLeft) / 16);
    clickY = Math.floor((evt.pageY - canvas.offsetTop) / 16);
    if (squares[clickX][clickY] === BOMB) {
        for (x = 0; x < 9; x += 1) {
            for (y = 0; y < 9; y += 1) {
                guesses[x][y] = 1;
            }
        }
        squares[clickX][clickY] === EXPLODED;
        gameover = 1;
    } else {
        if (!gameover && guesses[clickX][clickY] != 1) {
            guesses[clickX][clickY] = 1;
            score += 1;
            document.getElementById('scoreboard').style.color = 'white';
            document.getElementById('scoreboard').textContent = score;
        }
    }
    drawField();
}
*/

function main() {
    canvas = document.getElementById('canvas');
    context = canvas.getContext('2d');

    canvas.addEventListener("mousedown", userMousedDown, false);
    canvas.addEventListener("mouseup", userMousedUp, false);
    canvas.addEventListener("contextmenu", userRightClicked, false);

    sprite = new Image();
    sprite.src = 'mines.png';

    for (x = 0; x < 9; x += 1) {
        for (y = 0; y < 9; y += 1) {
            squares[x][y] = EMPTY;
        }
    }

    // Generate bomb locations
    x = 0;
    while (x < 10) {
        var randomX = Math.floor(Math.random() * 9), randomY = Math.floor(Math.random() * 9);
        if (squares[randomX][randomY] !== BOMB) {
            squares[randomX][randomY] = BOMB;
            x += 1;
        }
    }

    // Generate neighbour counts
    for (x = 0; x < 9; x += 1) {
        for (y = 0; y < 9; y += 1) {
            if (squares[x][y] !== BOMB) {
                var count = 0;
                count = count + isBomb(x - 1, y - 1);
                count = count + isBomb(x, y - 1);
                count = count + isBomb(x + 1, y - 1);

                count = count + isBomb(x - 1, y);
                count = count + isBomb(x + 1, y);

                count = count + isBomb(x - 1, y + 1);
                count = count + isBomb(x, y + 1);
                count = count + isBomb(x + 1, y + 1);
                if (count > 0) squares[x][y] = 4 + count;
            }
        }
    }

    // Draw minefield
    sprite.onload = function() {
        drawField();
    }

}

main();

</script>

</body>

</html>